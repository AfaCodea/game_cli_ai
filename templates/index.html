<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game AI Petualangan - Web Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --bg-gradient-light: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --bg-gradient-dark: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --panel-bg-light: rgba(255, 255, 255, 0.95);
            --panel-bg-dark: rgba(33, 37, 41, 0.95);
            --text-color-light: #212529;
            --text-color-dark: #f8f9fa;
            --chat-bg-light: #f8f9fa;
            --chat-bg-dark: #343a40;
        }
        
        body {
            background: var(--bg-gradient-dark);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color-dark);
            transition: background 0.3s ease;
        }
        
        body.light-mode {
            background: var(--bg-gradient-light);
            color: var(--text-color-light);
        }
        
        .game-container {
            background: var(--panel-bg-light);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin: 20px auto;
            max-width: 1200px;
            transition: background 0.3s ease;
        }
        
        .dark-mode .game-container {
            background: var(--panel-bg-dark);
        }
        
        .game-header {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            text-align: center;
        }
        
        .game-content {
            padding: 20px;
        }
        
        .status-panel {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .location-panel {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            background: var(--chat-bg-light);
            margin-bottom: 20px;
            transition: background 0.3s ease;
        }
        
        .dark-mode .chat-container {
            background: var(--chat-bg-dark);
            border-color: #495057;
        }
        
        /* Tooltip styles */
        .tooltip-inner {
            max-width: 200px;
            padding: 8px 12px;
            background-color: #343a40;
            border-radius: 6px;
        }
        
        .dark-mode .tooltip-inner {
            background-color: #f8f9fa;
            color: #343a40;
        }
        
        /* Theme toggle button */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .theme-toggle:hover {
            transform: rotate(30deg);
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
        }
        
        .message.user {
            background: #007bff;
            color: white;
            margin-left: 20%;
        }
        
        .message.game {
            background: #28a745;
            color: white;
            margin-right: 20%;
        }
        
        .message.error {
            background: #dc3545;
            color: white;
            margin-right: 20%;
        }
        
        .message.ai {
            background: #6f42c1;
            color: white;
            margin-right: 20%;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .quick-commands {
            margin-bottom: 20px;
        }
        
        .quick-command {
            margin: 5px;
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .quick-command:hover {
            transform: scale(1.05);
        }
        
        .inventory-panel {
            background: linear-gradient(45deg, #fa709a 0%, #fee140 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .quest-panel {
            background: linear-gradient(45deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .markdown-content {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }
        
        .markdown-content strong {
            font-weight: bold;
            color: #ffd700;
        }
        
        .game-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        @media (max-width: 768px) {
            .game-container {
                margin: 10px;
            }
            
            .message.user {
                margin-left: 10%;
            }
            
            .message.game, .message.error, .message.ai {
                margin-right: 10%;
            }
        }
    </style>
</head>
<body>
    <!-- Theme toggle button -->
    <button class="theme-toggle" id="themeToggle" title="Toggle Light/Dark Mode">
        <i class="bi bi-moon-fill"></i>
    </button>
    
    <div class="container-fluid">
        <div class="game-container">
            <div class="game-header">
                <h1><i class="fas fa-dragon"></i> Game AI Petualangan</h1>
                <p class="mb-0">Web Edition dengan AI Learning</p>
            </div>
            
            <div class="game-content">
                <!-- Loading -->
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>AI sedang berpikir...</p>
                </div>
                
                <!-- Status Panel -->
                <div class="status-panel" id="statusPanel">
                    <h5><i class="fas fa-user"></i> Status Pemain</h5>
                    <div class="game-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="playerName">Pahlawan</div>
                            <div class="stat-label">Nama</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value"><span id="health">100</span>/<span id="maxHealth">100</span></div>
                            <div class="stat-label">Health</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="level">1</div>
                            <div class="stat-label">Level</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="experience">0</div>
                            <div class="stat-label">Experience</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="gold">50</div>
                            <div class="stat-label">Gold</div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Panel -->
                <div class="location-panel" id="locationPanel">
                    <h5><i class="fas fa-map-marker-alt"></i> Lokasi Saat Ini</h5>
                    <div id="locationName">Hutan Misterius</div>
                    <div id="locationDescription">Memuat deskripsi lokasi...</div>
                    <div id="locationItems" style="margin-top: 10px;"></div>
                    <div id="locationNpcs" style="margin-top: 10px;"></div>
                </div>
                
                <!-- Chat Container -->
                <div class="chat-container" id="chatContainer">
                    <div class="message game">
                        <strong>Game:</strong> Selamat datang di dunia petualangan! Ketik 'help' untuk melihat perintah yang tersedia.
                    </div>
                </div>
                
                <!-- Quick Commands -->
                <div class="quick-commands">
                    <h6><i class="fas fa-bolt"></i> Perintah Cepat:</h6>
                    <button class="quick-command" onclick="executeCommand('lihat')">Lihat</button>
                    <button class="quick-command" onclick="executeCommand('status')">Status</button>
                    <button class="quick-command" onclick="executeCommand('inventaris')">Inventaris</button>
                    <button class="quick-command" onclick="executeCommand('quest')">Quest</button>
                    <button class="quick-command" onclick="executeCommand('help')">Help</button>
                    <button class="quick-command" onclick="executeCommand('ai_learn')">AI Learn</button>
                    <button class="quick-command" onclick="executeCommand('ai_suggest')">AI Suggest</button>
                </div>
                
                <!-- Command Input -->
                <div class="input-group">
                    <input type="text" class="form-control" id="commandInput" placeholder="Ketik perintah Anda di sini..." onkeypress="handleKeyPress(event)">
                    <button class="btn btn-primary" onclick="executeCommand()">
                        <i class="fas fa-paper-plane"></i> Kirim
                    </button>
                </div>
                
                <!-- Inventory Panel -->
                <div class="inventory-panel" id="inventoryPanel" style="display: none;">
                    <h5><i class="fas fa-briefcase"></i> Inventaris</h5>
                    <div id="inventoryContent"></div>
                </div>
                
                <!-- Quest Panel -->
                <div class="quest-panel" id="questPanel" style="display: none;">
                    <h5><i class="fas fa-scroll"></i> Quest</h5>
                    <div id="questContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let sessionId = null;
        let gameStatus = null;

        // Initialize game
        window.onload = function() {
            startGame();
        };

        async function startGame() {
            try {
                const response = await fetch('/api/game/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: Date.now().toString()
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    sessionId = data.session_id;
                    addMessage('game', data.message);
                    updateGameStatus();
                }
            } catch (error) {
                console.error('Error starting game:', error);
                addMessage('error', 'Error memulai game: ' + error.message);
            }
        }

        async function updateGameStatus() {
            if (!sessionId) return;
            
            try {
                const response = await fetch(`/api/game/status?session_id=${sessionId}`);
                const data = await response.json();
                
                if (data.error) {
                    addMessage('error', data.error);
                    return;
                }
                
                gameStatus = data;
                
                // Update status panel
                document.getElementById('playerName').textContent = data.player_name;
                document.getElementById('health').textContent = data.health;
                document.getElementById('maxHealth').textContent = data.max_health;
                document.getElementById('level').textContent = data.level;
                document.getElementById('experience').textContent = data.experience;
                document.getElementById('gold').textContent = data.gold;
                
                // Update location panel
                document.getElementById('locationName').textContent = data.current_location.name;
                document.getElementById('locationDescription').textContent = data.current_location.description;
                
                // Update location items
                const itemsDiv = document.getElementById('locationItems');
                if (data.current_location.items.length > 0) {
                    itemsDiv.innerHTML = '<strong>Item yang terlihat:</strong> ' + 
                        data.current_location.items.map(item => item.name).join(', ');
                } else {
                    itemsDiv.innerHTML = '';
                }
                
                // Update location NPCs
                const npcsDiv = document.getElementById('locationNpcs');
                if (data.current_location.npcs.length > 0) {
                    npcsDiv.innerHTML = '<strong>NPC yang terlihat:</strong> ' + 
                        data.current_location.npcs.join(', ');
                } else {
                    npcsDiv.innerHTML = '';
                }
                
            } catch (error) {
                console.error('Error updating game status:', error);
            }
        }

        async function executeCommand(command = null) {
            const input = document.getElementById('commandInput');
            const cmd = command || input.value.trim();
            
            if (!cmd) return;
            
            if (!sessionId) {
                addMessage('error', 'Game belum dimulai');
                return;
            }
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            
            // Add user message
            addMessage('user', cmd);
            
            // Clear input
            input.value = '';
            
            try {
                const response = await fetch('/api/game/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        command: cmd
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    addMessage('error', data.error);
                } else {
                    // Add game response
                    const messageType = cmd.startsWith('tanya') || cmd === 'ai_learn' || cmd === 'ai_suggest' ? 'ai' : 'game';
                    addMessage(messageType, data.result);
                    
                    // Update game status
                    gameStatus = data.game_status;
                    updateGameStatus();
                    
                    // Show/hide panels based on command
                    if (cmd === 'inventaris') {
                        showInventoryPanel();
                    } else if (cmd === 'quest') {
                        showQuestPanel();
                    } else {
                        hidePanels();
                    }
                }
                
            } catch (error) {
                console.error('Error executing command:', error);
                addMessage('error', 'Error menjalankan perintah: ' + error.message);
            } finally {
                // Hide loading
                document.getElementById('loading').style.display = 'none';
            }
        }

        function addMessage(type, content) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            // Convert markdown-like formatting
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            messageDiv.innerHTML = `<strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> <span class="markdown-content">${content}</span>`;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                executeCommand();
            }
        }

        function showInventoryPanel() {
            if (!gameStatus) return;
            
            const panel = document.getElementById('inventoryPanel');
            const content = document.getElementById('inventoryContent');
            
            if (gameStatus.inventory.length > 0) {
                let html = '<div class="row">';
                gameStatus.inventory.forEach(item => {
                    html += `
                        <div class="col-md-6 mb-2">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">${item.name}</h6>
                                    <p class="card-text">${item.description}</p>
                                    <small>Berat: ${item.weight} | Nilai: ${item.value}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                content.innerHTML = html;
            } else {
                content.innerHTML = '<p>Inventaris kosong.</p>';
            }
            
            panel.style.display = 'block';
            document.getElementById('questPanel').style.display = 'none';
        }

        function showQuestPanel() {
            if (!gameStatus) return;
            
            const panel = document.getElementById('questPanel');
            const content = document.getElementById('questContent');
            
            let html = '';
            gameStatus.quests.forEach(quest => {
                const status = quest.completed ? '✅ Selesai' : quest.started ? '🔄 Aktif' : '📋 Tersedia';
                const statusClass = quest.completed ? 'text-success' : quest.started ? 'text-warning' : 'text-info';
                
                html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">${quest.title} (${quest.id})</h6>
                            <p class="card-text">${quest.description}</p>
                            <span class="badge ${statusClass}">${status}</span>
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = html;
            panel.style.display = 'block';
            document.getElementById('inventoryPanel').style.display = 'none';
        }

        function hidePanels() {
            document.getElementById('inventoryPanel').style.display = 'none';
            document.getElementById('questPanel').style.display = 'none';
        }
    </script>
</body>
</html>